# Description
Run openmrs reference application and mysql as disposable docker containers
for demo server.

The docker image used was generated by OpenMRS SDK, and deployed to Docker hub:
```
$ mvn org.openmrs.maven.plugins:openmrs-sdk-maven-plugin:3.7.0:build-distro -B -Ddir=demo-server -Ddistro=rerenceapplication:<version>
$ cd demo-server/web/
$ docker build -t <username>/<image>:<version> .
$ docker push <username>/<image>:<version>

$ docker tag <username>/<image>:<version> <username>/<image>:demo
$ docker push <username>/referenceapplication-docker-image:demo
```


## Requirements
  - Docker engine 1.12.0+
  - Docker compose 1.9.0+

## Running it locally

To start both containers:
```
$ docker-compose down -v
$ VERSION=2.5 docker-compose up
```
If you don't add a _VERSION_ variable, it will use `demo` docker tag.

Application will be eventually accessible on http://localhost:8080/openmrs.
Credentials on shipped demo data:
  - Username: admin
  - Password: Admin123

Use _CTRL + C_ to stop it all containers. But make sure to destroy containers to delete any
left overs volumes and data when doing changes to the docker configuration and images:

```
$ docker-compose down -v
```

### Generate demo data / database from scratch
If you want to generate the SQL with the demo data:

  - Comment docker volume `./dbdump` to ignore previous SQL dumps
  - Uncomment docker volume `openmrs-referenceapplication-mysql-data` to allow
  data being persisted between docker runs.
  - Change environment variables _DB_CREATE_TABLES_ and _DB_AUTO_UPDATE_ to true
  to allow OpenMRS to recreate the database schema.
  - Run `docker-compose up` and wait for the application to load
  - Login to OpenMRS and change the global setting
  `referencedemodata.createDemoPatientsOnNextStartup` to 500
  - Run `docker-compose down && docker-compose up` to restart the application.
  This will take quite a while. Wait for the application to load again.
  - Enter the DB docker container (`docker exec -it <container_db_id> bash`)
  - From inside the container, run
  `mysqldump --user=openmrs --password=$PASSWORD openmrs > /tmp/dump.sql`
  - From outside the container, copy the dump file to your machine:
  `docker cp <container_db_id>:/tmp/dump.sql .`

You'll want to replace the SQL file in dbdump, but no other changes should be committed.
